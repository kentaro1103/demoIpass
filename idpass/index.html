<!doctype html>
<html lang="jp">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>iPassクリエイター</title>

  <!-- Bootstrap core CSS -->
  <link href="./bootstrap-4.0.0-dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles for this template -->
  <link href="./css/index.css" rel="stylesheet">
  <!-- datatables -->
  <link href="./DataTables/datatables.min.css" rel="stylesheet" type="text/css" />
</head>

<body>

  <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="#">iPass クリエイター</a>
  </nav>

  <main role="main" class="container-fluid">

    <form id="from" autocomplete="off">
      <div class="form-group row mb-5 ml-0">
        <div class="col-sm-4">
          <input type="text" id="in_id" class="form-control" placeholder="ここにIDを入力してください。" required autofocus>
        </div>
        <div class="col-sm-2">
          <input type="submit" id="in_submit" class="btn btn-info" value="iPassを作成">
        </div>
      </div>
      <div class="form-group">
        <div class="col-sm-8">
          <h4>登録済みのIDとパスワード</h4>
          <table id="table" class="table table-hover table-sm">
            <thead class="thead-light">
              <tr>
                <th class="border-top-0 border-bottom-0">登録済みID</th>
                <th class="border-0" scope="col">パスワード</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
    </form>

  </main>

  <!-- Bootstrap core JavaScript
    ================================================== -->
  <script src="./js/vendor/jquery-slim.min.js"></script>
  <script src="./js/vendor/popper.min.js"></script>
  <script src="./bootstrap-4.0.0-dist/js/bootstrap.min.js"></script>
  <!-- datatables -->
  <script src="./DataTables/datatables.min.js"></script>

  <script type="text/javascript">
    $(function () {
      // テーブルデータ
      var data = [];

      // テーブル表示
      function reload() {
        if ($('#table').hasClass('dataTable')) {
          $('#table').DataTable().destroy();
        }
        $('#table').DataTable({
          lengthChange: false,  // 件数切替機能 無効
          searching: false,     // 検索機能 無効
          ordering: false,      // ソート機能 無効
          info: false,          // 情報表示 無効
          paging: false,        // ページング機能 無効
          scrollY: 300,         // 縦スクロールバーを有効
          language: {
            "emptyTable": "IDとパスワードが存在しません。"  // メッセージ変更
          },
          data: data,           // データ
          columns: [
            { data: "id" },
            { data: "pass" },
          ]
        });
      }

      // テーブル初期表示
      reload();

      // iPass作成アクション
      $('#from').submit(function () {
        // alert('クリックされました=' + $('#in_id').val());
        var in_id = $.trim($('#in_id').val());
        // チェック
        if (isBlank(in_id)) {
          alert('IDを入力してください。');
          return false;
        }
        if (exists(in_id)) {
          alert('ID「' + in_id + '」は既に登録済みです。');
          return false;
        }

        // iPass自動生成
        data.unshift({ 'id': escapeHtml(in_id), 'pass': escapeHtml(getPass()) });
        console.log(JSON.stringify(data, null, '\t'));
        
        // テーブル表示
        reload();
        $('#in_id').val('');

        return false;
      });

      // ID存在チェック
      function exists(_id) {
        return data.some(function (e) {
          return (e.id === _id);
        });
      }

      /****************************************************************************
       * common
      ****************************************************************************/

      // 必須チェック
      function isBlank(str) {
        return ($.trim(str).length == 0);
      }

      // 乱数生成
      var ransu = function (n) {
        var str = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
          + '!"#$%&()-=@+*/?<>,.';
        str = str.split('');
        var s = '';
        for (var i = 0; i < n; i++) {
          s += str[Math.floor(Math.random() * str.length)];
        }
        return s;
      };

      // pass生成
      function getPass() {
        var code = '';
        var i = 0;
        while (code = ransu(8)) {
          if (code.match(/^(?=.*?[a-z])(?=.*?[A-Z])(?=.*?\d)(?=.*?[!-\/:-@[-`{-~])[!-~]{8,100}$/i)) {
            console.log(code)
            break;
          }
        }
        return code;
      }

      // HTMLエスケープ
      function escapeHtml(str) {
        return $('<span/>').text(str).html();
      }

    });
  </script>
</body>

</html>